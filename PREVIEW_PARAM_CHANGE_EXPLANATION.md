# 预览画面参数变化说明

## 📋 问题：为什么调整参数后预览画面没有明显变化？

### 核心原因分析

#### 1. **参数应用流程**

⚠️ **重要：修改下拉框 ≠ 参数已生效**

正确的流程：
1. **修改参数**：在下拉框中选择新值（例如：ISO 从 200 改为 1600）
2. **应用参数**：点击"应用参数"按钮
3. **等待生效**：相机需要 0.5-2 秒来应用新参数
4. **预览更新**：预览帧会反映新参数（但可能有延迟）

❌ **常见错误**：
- 只修改了下拉框，没有点击"应用参数"
- 点击"应用参数"后立即查看，参数还没生效

---

#### 2. **预览帧更新机制**

**CameraAgent 端：**
- 预览帧每 **120ms** 从相机 EVF（电子取景器）获取一次
- EVF 帧反映相机的**实时状态**，包括当前参数

**前端刷新：**
- 每 **300ms** 请求一次 `/preview/frame`
- 获取的是 CameraAgent 缓存的最新帧

**延迟说明：**
- 参数应用后 → 相机生效（0.5-2秒）→ EVF 更新（120ms）→ 前端显示（300ms）
- **总延迟：约 1-3 秒**

---

#### 3. **哪些参数在预览中变化明显？**

### ✅ **明显变化的参数**

| 参数 | 变化效果 | 测试建议 |
|------|---------|---------|
| **ISO** | 画面亮度变化 | ISO 100 → 1600，画面应该明显变亮 |
| **白平衡 (WB)** | 画面色温变化 | DAYLIGHT（冷） ↔ TUNGSTEN（暖），色温明显不同 |
| **曝光补偿 (EV)** | 画面亮度线性变化 | +1.0 EV 变亮，-1.0 EV 变暗 |
| **光圈 (Aperture)** | 景深变化（如果对焦距离合适） | F2.8（浅景深） ↔ F16（深景深） |

### ⚠️ **变化不明显的参数**

| 参数 | 原因 | 说明 |
|------|------|------|
| **图片风格 (PictureStyle)** | 主要是后期处理效果 | 在预览中可能不明显，需要拍照后对比 |
| **测光模式 (MeteringMode)** | 影响曝光计算，但预览可能已自动曝光 | 在自动模式下可能看不出区别 |
| **快门速度 (ShutterSpeed)** | 如果场景静止，看不出区别 | 只有拍摄运动物体时才有明显区别 |

---

## 🧪 详细测试步骤

### 测试 1：ISO 变化（最明显）

**步骤：**
1. 开启预览开关
2. 等待 2-3 秒，让预览稳定
3. 找到"ISO"下拉框
4. 选择 **ISO 100**（较暗）
5. 点击"应用参数"按钮
6. 等待 2-3 秒
7. 观察预览画面：应该**变暗**
8. 再选择 **ISO 1600**（较亮）
9. 点击"应用参数"
10. 等待 2-3 秒
11. 观察预览画面：应该**变亮**

**预期结果：**
- ✅ 画面亮度有明显变化（暗 ↔ 亮）
- ✅ 变化在 2-3 秒内可见

---

### 测试 2：白平衡变化（色温明显）

**步骤：**
1. 开启预览
2. 等待预览稳定
3. 找到"白平衡"下拉框
4. 选择 **DAYLIGHT**（日光，偏冷/蓝）
5. 点击"应用参数"
6. 等待 2-3 秒
7. 观察画面：应该偏**冷色调（蓝/白）**
8. 再选择 **TUNGSTEN**（钨丝灯，偏暖/黄）
9. 点击"应用参数"
10. 等待 2-3 秒
11. 观察画面：应该偏**暖色调（黄/橙）**

**预期结果：**
- ✅ 画面色温有明显变化（冷 ↔ 暖）
- ✅ 如果室内有灯光，变化会更明显

---

### 测试 3：曝光补偿变化（亮度线性）

**步骤：**
1. 开启预览
2. 找到"曝光补偿 (EV)"输入框
3. 输入 **-1.0**（减少曝光）
4. 点击"应用参数"
5. 等待 2-3 秒
6. 观察画面：应该**变暗**
7. 再输入 **+1.0**（增加曝光）
8. 点击"应用参数"
9. 等待 2-3 秒
10. 观察画面：应该**变亮**

**预期结果：**
- ✅ 画面亮度线性变化
- ✅ -EV 变暗，+EV 变亮

---

## 🔍 如何验证参数是否真的生效？

### 方法 1：对比测试拍照

1. 应用参数前，点击"测试拍照"，保存照片 A
2. 修改参数（例如 ISO 100 → 1600）
3. 点击"应用参数"
4. 等待 3 秒
5. 点击"测试拍照"，保存照片 B
6. 对比两张照片：
   - ISO 变化：照片 B 应该比照片 A 亮
   - WB 变化：照片 B 的色温应该不同

### 方法 2：查看相机状态

1. 应用参数后
2. 点击"刷新"按钮
3. 查看"当前参数"区域
4. 确认参数值已更新

### 方法 3：查看 Network 面板

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 点击"应用参数"
4. 应该能看到请求：`POST /local/camera/apply-params`
5. 状态码应该是 200（成功）

---

## ⚠️ 常见问题

### Q1: 为什么我修改了参数，但预览没变化？

**可能原因：**
1. ❌ **没有点击"应用参数"按钮**（最常见）
2. ⏱️ **等待时间不够**（参数需要 1-3 秒生效）
3. 📸 **参数变化不明显**（如测光模式、图片风格）
4. 🔄 **预览帧延迟**（前端 300ms 刷新一次）

**解决方法：**
- ✅ 确保点击了"应用参数"按钮
- ✅ 等待 3-5 秒再观察
- ✅ 使用明显变化的参数测试（ISO、WB、EV）

---

### Q2: 为什么有些参数变化不明显？

**原因：**
- **图片风格**：主要是后期处理，预览中不明显
- **测光模式**：影响曝光计算，但预览可能已自动曝光
- **快门速度**：只有拍摄运动物体时才有区别

**建议：**
- 使用 **ISO、WB、EV** 这三个参数测试，变化最明显
- 其他参数可以通过"测试拍照"验证

---

### Q3: 预览画面卡顿或不流畅？

**原因：**
- 预览帧更新频率：CameraAgent 120ms，前端 300ms
- 网络延迟：MVP → CameraAgent → 相机
- 相机性能：某些相机 EVF 更新较慢

**这是正常的：**
- 预览主要用于"调参参考"，不是实时视频流
- 3fps 的刷新率足够看到参数变化

---

## ✅ 快速验证清单

### 必须满足的条件

- [ ] 预览开关已开启（显示 ON）
- [ ] 能看到预览画面（不是占位符）
- [ ] 修改参数后，**点击了"应用参数"按钮**
- [ ] 等待了 2-3 秒让参数生效
- [ ] 使用了明显变化的参数（ISO、WB、EV）

### 测试结果

- [ ] ISO 100 → 1600：画面明显变亮 ✅
- [ ] WB DAYLIGHT → TUNGSTEN：色温明显变化 ✅
- [ ] EV -1.0 → +1.0：画面亮度变化 ✅

**如果以上都满足，说明预览功能正常！**

---

## 🎯 总结

1. **参数应用流程**：修改 → 应用 → 等待 → 观察
2. **明显变化的参数**：ISO、WB、EV
3. **不明显变化的参数**：PictureStyle、MeteringMode（需要拍照验证）
4. **延迟是正常的**：参数生效需要 1-3 秒
5. **预览帧更新**：每 300ms 刷新一次，可能看到延迟

**如果按照上述步骤测试，应该能看到明显的参数变化！**
