# 预览功能测试步骤（详细版）

## 📋 测试前准备

### 1. 启动服务
```bash
# 终端 1：启动 MVP 后端服务
cd D:\workspace\ai-photo-booth-mvp
# 运行你的启动命令（例如：mvn spring-boot:run 或 ./gradlew bootRun）

# 终端 2：启动 Kiosk 前端服务
cd D:\workspace\ai-photo-booth-kiosk
npm run dev
```

### 2. 打开浏览器
- 打开 Chrome 或 Edge 浏览器
- 打开开发者工具（F12）
- 切换到 **Network（网络）** 标签页
- 确保 **Disable cache（禁用缓存）** 已勾选

---

## 🧪 测试 A：MVP 未实现 preview.jpg 的情况

### 目标
验证当后端接口不存在时，UI 能正确处理错误，不会无限刷请求。

---

### 步骤 1：进入 Settings 页面

1. 在浏览器地址栏输入：`http://localhost:5173`（或你的前端端口）
2. 在首页左上角 **60x60 像素区域**快速点击 **7 次**（2 秒内）
3. 会弹出 PIN 输入框
4. 输入 PIN：`1234`
5. 点击"确认"
6. 应该进入 Settings 页面，默认显示 **Camera** Tab

**预期结果：**
- ✅ 能看到 Settings 页面
- ✅ Camera Tab 是激活状态（蓝色高亮）
- ✅ 能看到相机状态、预设列表、参数编辑区

---

### 步骤 2：找到预览区域

1. 在 Camera Tab 中向下滚动
2. 找到 **"实时预览"** 区域（在"相机状态"下方）
3. 应该看到：
   - 标题："实时预览"
   - 右侧有一个开关（Toggle Switch），显示 **OFF**
   - 下方有一个深色矩形区域，显示"预览已关闭"

**预期结果：**
- ✅ 能看到预览区域
- ✅ 开关显示 OFF
- ✅ 预览区域显示占位符

---

### 步骤 3：开启预览开关

1. 点击右侧的 **Toggle Switch**（或点击开关旁边的文字）
2. 开关应该从 OFF 切换到 ON（蓝色高亮）

**预期结果：**
- ✅ 开关状态变为 ON
- ✅ 开关文字显示 "ON"

---

### 步骤 4：观察错误处理

**立即检查（开启后 1 秒内）：**

1. 查看预览区域：
   - 应该显示错误提示："Preview not available (endpoint missing or camera not ready)."
   - 错误提示是红色文字，在深色覆盖层上

2. 查看开关状态：
   - 开关应该**自动变回 OFF**（因为检测到错误）

3. 查看状态栏：
   - 状态应该显示："状态: **OFF**"

4. 查看 Network 面板：
   - 应该能看到 1-2 个请求到 `/local/camera/preview.jpg`
   - 状态码应该是 **404**（Not Found）
   - **不应该**看到无限刷新的请求（不应该每 300ms 都发请求）

**预期结果：**
- ✅ 显示错误提示
- ✅ 开关自动关闭
- ✅ Network 面板只有 1-2 个请求，没有无限刷新
- ✅ 能看到"重试"按钮

---

### 步骤 5：测试重试按钮

1. 点击 **"重试"** 按钮
2. 观察：
   - 开关应该再次变为 ON
   - 然后立即又变回 OFF（因为接口仍然不存在）
   - 错误提示再次显示

**预期结果：**
- ✅ 重试按钮可以点击
- ✅ 重试后仍然正确处理错误
- ✅ 不会无限刷新

---

### 步骤 6：手动关闭开关

1. 如果开关还是 ON，手动点击关闭
2. 观察：
   - 开关变为 OFF
   - 预览区域显示"预览已关闭"
   - Network 面板不再有新的请求

**预期结果：**
- ✅ 可以手动关闭开关
- ✅ 关闭后不再发送请求

---

## ✅ 测试 A 验收标准

- [ ] 开启预览后，立即显示错误提示
- [ ] 开关自动关闭（不会一直保持 ON）
- [ ] Network 面板只有 1-2 个请求，没有无限刷新
- [ ] 显示"重试"按钮
- [ ] 可以手动关闭开关
- [ ] 关闭后不再发送请求

**如果以上都满足，说明错误处理逻辑正确 ✅**

---

## 🧪 测试 B：MVP 已实现 preview.jpg 的情况

### 目标
验证预览功能正常工作，能实时显示相机画面，并反映参数变化。

---

### 前置条件

1. **确保 MVP 后端已实现 `/local/camera/preview.jpg` 接口**
2. **确保相机已连接并正常工作**

---

### 步骤 1：进入 Settings 页面

1. 打开浏览器：`http://localhost:5173`
2. 左上角 7 连击 → 输入 PIN `1234` → 进入 Settings
3. 确保在 **Camera** Tab

**预期结果：**
- ✅ 进入 Settings 页面

---

### 步骤 2：开启预览

1. 找到 **"实时预览"** 区域
2. 点击开关，从 OFF 切换到 ON

**预期结果：**
- ✅ 开关变为 ON（蓝色）
- ✅ 预览区域开始显示画面（不是占位符）

---

### 步骤 3：观察预览刷新

**立即检查（开启后 3-5 秒）：**

1. **查看预览画面：**
   - 应该能看到相机实时画面
   - 画面应该每 300ms 左右刷新一次（可能不够流畅，但能看到变化）

2. **查看状态栏：**
   - 状态：**ON**
   - FPS：应该显示约 **3.0-3.5**（因为 300ms 间隔 ≈ 3.3 fps）
   - 最后更新：显示时间（例如："刚刚" 或 "1秒前"）

3. **查看 Network 面板：**
   - 应该能看到持续请求 `/local/camera/preview.jpg?t=...`
   - 请求间隔约 300ms
   - 状态码应该是 **200**（成功）
   - 每个请求的 `t` 参数都不同（时间戳）

**预期结果：**
- ✅ 能看到预览画面
- ✅ 画面在刷新（虽然可能不够流畅）
- ✅ FPS 显示约 3.3
- ✅ Network 面板持续请求，间隔约 300ms

---

### 步骤 4：测试白平衡（WB）变化

1. **找到参数编辑区**（在预设列表下方）
2. **找到"白平衡"下拉框**
3. **记录当前值**（例如：DAYLIGHT）
4. **切换到另一个值**（例如：TUNGSTEN）
   - 注意：**不要点击"应用参数"**，先只修改下拉框
5. **观察预览画面：**
   - 画面**不应该**立即变化（因为还没应用）
6. **点击"应用参数"按钮**
7. **立即观察预览画面（应用后 1-2 秒内）：**
   - 画面色温应该明显变化
   - DAYLIGHT（日光）→ 画面偏冷/偏蓝
   - TUNGSTEN（钨丝灯）→ 画面偏暖/偏黄

**预期结果：**
- ✅ 应用参数后，预览画面色温明显变化
- ✅ 变化在 1-2 秒内可见

---

### 步骤 5：测试 ISO 变化

1. **找到"ISO"下拉框**
2. **记录当前值**（例如：400）
3. **切换到另一个值**（例如：1600）
4. **点击"应用参数"**
5. **立即观察预览画面：**
   - 画面亮度应该明显变化
   - ISO 100 → 画面较暗
   - ISO 1600 → 画面较亮

**预期结果：**
- ✅ 应用参数后，预览画面亮度明显变化
- ✅ 变化在 1-2 秒内可见

---

### 步骤 6：测试曝光补偿（EV）变化

1. **找到"曝光补偿 (EV)"输入框**
2. **记录当前值**（例如：0.0）
3. **修改为 +1.0**
4. **点击"应用参数"**
5. **观察预览画面：**
   - 画面应该变亮
6. **再修改为 -1.0**
7. **点击"应用参数"**
8. **观察预览画面：**
   - 画面应该变暗

**预期结果：**
- ✅ 应用参数后，预览画面亮度线性变化
- ✅ +EV 变亮，-EV 变暗

---

### 步骤 7：验证 FPS 和状态更新

1. **保持预览开启 10 秒**
2. **观察状态栏：**
   - FPS 应该稳定在 **3.0-3.5** 左右
   - 最后更新时间应该持续更新（"刚刚"、"1秒前"等）

**预期结果：**
- ✅ FPS 稳定在 3.0-3.5
- ✅ 最后更新时间持续更新

---

### 步骤 8：测试关闭预览

1. **点击开关，从 ON 切换到 OFF**
2. **观察：**
   - 预览画面消失
   - 显示"预览已关闭"占位符
   - Network 面板不再有新的请求
   - 状态显示："状态: **OFF**"
   - FPS 不再显示

**预期结果：**
- ✅ 预览停止
- ✅ Network 面板停止请求
- ✅ 状态正确更新

---

## ✅ 测试 B 验收标准

- [ ] 开启预览后能看到实时画面
- [ ] 画面每 300ms 左右刷新一次
- [ ] FPS 显示约 3.0-3.5
- [ ] 修改 WB 后，预览画面色温明显变化
- [ ] 修改 ISO 后，预览画面亮度明显变化
- [ ] 修改 EV 后，预览画面亮度线性变化
- [ ] 关闭预览后，停止刷新和请求

**如果以上都满足，说明预览功能完全正常 ✅**

---

## 🔍 常见问题排查

### 问题 1：开启预览后没有任何反应

**检查：**
1. 打开浏览器控制台（Console），查看是否有错误
2. 检查 Network 面板，看是否有请求发出
3. 检查请求的 URL 是否正确：`http://localhost:8080/local/camera/preview.jpg?t=...`

**可能原因：**
- MVP 服务未启动
- 端口不对（不是 8080）
- 网络请求被阻止

---

### 问题 2：预览一直显示错误，但后端已实现接口

**检查：**
1. 在浏览器直接访问：`http://localhost:8080/local/camera/preview.jpg`
2. 看是否能直接看到图片
3. 检查 Network 面板，看请求的状态码和响应

**可能原因：**
- 接口路径不对
- 相机未连接
- 接口返回的不是图片格式

---

### 问题 3：预览画面不刷新

**检查：**
1. 查看 Network 面板，看请求是否持续发出
2. 检查每个请求的 `t` 参数是否不同
3. 查看浏览器控制台是否有错误

**可能原因：**
- 定时器未启动
- 图片被缓存（检查 Disable cache 是否勾选）
- 接口返回的图片未更新

---

### 问题 4：FPS 显示为 0 或不准确

**检查：**
1. 等待 3-5 秒，让 FPS 计算稳定
2. 查看 Network 面板，确认请求频率

**说明：**
- FPS 是基于实际加载次数计算的
- 如果图片加载失败，FPS 可能为 0
- 正常情况应该约 3.3 fps（300ms 间隔）

---

## 📝 测试记录模板

```
测试日期：____年__月__日
测试人员：_______

测试 A（错误处理）：
[ ] 步骤 1：进入 Settings 页面
[ ] 步骤 2：找到预览区域
[ ] 步骤 3：开启预览开关
[ ] 步骤 4：观察错误处理
[ ] 步骤 5：测试重试按钮
[ ] 步骤 6：手动关闭开关

测试 B（正常功能）：
[ ] 步骤 1：进入 Settings 页面
[ ] 步骤 2：开启预览
[ ] 步骤 3：观察预览刷新
[ ] 步骤 4：测试 WB 变化
[ ] 步骤 5：测试 ISO 变化
[ ] 步骤 6：测试 EV 变化
[ ] 步骤 7：验证 FPS 和状态
[ ] 步骤 8：测试关闭预览

问题记录：
1. 
2. 
3. 

测试结论：✅ 通过 / ❌ 失败
```

---

## 🎯 快速验收清单

### 测试 A（5 分钟）
- [ ] 开启预览 → 显示错误 → 自动关闭 → 停止刷新 ✅

### 测试 B（10 分钟）
- [ ] 开启预览 → 看到画面 → FPS 约 3.3 ✅
- [ ] 调 WB → 画面色温变化 ✅
- [ ] 调 ISO → 画面亮度变化 ✅
- [ ] 调 EV → 画面亮度变化 ✅
- [ ] 关闭预览 → 停止刷新 ✅

**如果以上都通过，预览功能验收完成！🎉**
